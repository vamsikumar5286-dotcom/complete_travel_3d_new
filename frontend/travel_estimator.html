<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel Cost Estimator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --bg-color: #1a1a2e;
            --card-color: #2c2c44;
            --text-color: #e4e4e7;
            --accent-color: #ff5757;
            --success-color: #4CAF50;
            --activity-color: #00bcd4; /* Cyan for Activity */
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--text-color); }
        .card { max-width: 600px; }
        .input-style {
            background-color: #3b3b5c;
            border: 1px solid #5a5a7b;
            color: var(--text-color);
            transition: all 0.2s;
        }
        .input-style:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(255, 87, 87, 0.5);
        }
        .hidden { display: none; }
        /* Custom styling for breakdown sections */
        .breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            background-color: rgba(60, 60, 85, 0.5); /* Lighter card background */
        }
    </style>
</head>
<body class="p-4 sm:p-8 flex items-center justify-center min-h-screen">

    <!-- Loading Indicator -->
    <div id="loadingScreen" class="absolute inset-0 bg-card-color flex flex-col items-center justify-center z-50 transition-opacity duration-500">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-accent-color"></div>
        <p class="mt-4 text-white">Initializing Firebase...</p>
    </div>

    <!-- Main Content Card -->
    <div class="card bg-card-color p-6 sm:p-10 rounded-2xl shadow-2xl w-full hidden" id="mainAppContainer">
        
        <!-- Header -->
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-extrabold text-white">Travel Estimator</h1>
            <button id="logoutButton" class="text-sm text-gray-400 hover:text-accent-color transition duration-200 hidden">Logout</button>
        </div>
        
        <!-- 1. LOGIN/SIGNUP VIEW -->
        <div id="authView" class="hidden">
            <h2 class="text-xl font-bold mb-4 text-white">Account Access</h2>
            <div id="authMessage" class="p-3 mb-4 rounded-lg text-sm bg-blue-900 text-blue-200 hidden"></div>
            
            <input type="email" id="authEmail" placeholder="Email" class="input-style w-full p-3 rounded-lg mb-3">
            <input type="password" id="authPassword" placeholder="Password" class="input-style w-full p-3 rounded-lg mb-6">

            <button id="loginButton" class="w-full bg-accent-color hover:bg-red-700 text-white font-semibold py-3 rounded-lg transition duration-200 shadow-md mb-3">
                Login
            </button>
            <button id="signupButton" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold py-3 rounded-lg transition duration-200 shadow-md">
                Sign Up
            </button>
        </div>

        <!-- 2. ESTIMATION VIEW (Current Content) -->
        <div id="estimationView" class="hidden">
            <p class="text-sm text-gray-400 mb-6" id="welcomeMessage">Welcome! Enter your trip details.</p>

            <div id="input-fields" class="space-y-4 mb-8">
                <!-- Trip Inputs -->
                <input type="text" id="startLocation" placeholder="Start Location (e.g., New York)" class="input-style w-full p-3 rounded-lg" value="Mumbai">
                <input type="text" id="destination" placeholder="Destination (e.g., Paris)" class="input-style w-full p-3 rounded-lg" value="Goa">
                <input type="text" id="country" placeholder="Country (e.g., France)" class="input-style w-full p-3 rounded-lg" value="India">
                
                <!-- Transportation Type -->
                <div>
                    <label for="transportType" class="block text-sm font-medium mb-1 text-gray-300">Transportation Type (ML Model)</label>
                    <select id="transportType" class="input-style w-full p-3 rounded-lg appearance-none">
                        <option value="" disabled selected>Select Primary Type</option>
                        <option value="Train">Train</option>
                        <option value="Bus">Bus</option>
                        <option value="Flight">Flight</option>
                        <option value="Car">Car</option>
                        <option value="Bike">Bike</option>
                    </select>
                </div>
                
                <!-- Number of Days -->
                <input type="number" id="numberOfDays" placeholder="Number of Days" value="7" min="1" class="input-style w-full p-3 rounded-lg">

                <!-- Accommodation Type -->
                <div>
                    <label for="accommodationType" class="block text-sm font-medium mb-1 text-gray-300">Accommodation Type (ML Model)</label>
                    <select id="accommodationType" class="input-style w-full p-3 rounded-lg appearance-none">
                        <option value="" disabled selected>Select Accommodation</option>
                        <option value="Hostel">Hostel (Budget)</option>
                        <option value="3Star">3-Star Hotel</option>
                        <option value="4Star">4-Star Hotel</option>
                        <option value="5Star">5-Star Hotel</option>
                        <option value="Airbnb">Airbnb (Flexible)</option>
                    </select>
                </div>

                <!-- Food Preference -->
                <div>
                    <label for="foodPreference" class="block text-sm font-medium mb-1 text-gray-300">Food Preference (Rule-Based)</label>
                    <select id="foodPreference" class="input-style w-full p-3 rounded-lg appearance-none">
                        <option value="" disabled selected>Select Daily Dining Cost</option>
                        <option value="Low">Low Cost ($7/day)</option>
                        <option value="Medium">Medium Cost ($11/day)</option>
                        <option value="High">High Cost ($25/day)</option>
                    </select>
                </div>
                
                <!-- NEW INPUT: Activity Preference -->
                <div>
                    <label for="activityPreference" class="block text-sm font-medium mb-1 text-gray-300">Activity Preference (Rule-Based)</label>
                    <select id="activityPreference" class="input-style w-full p-3 rounded-lg appearance-none">
                        <option value="" disabled selected>Select Daily Activity Cost</option>
                        <option value="Low">Low ($12/day)</option>
                        <option value="Medium">Medium ($35/day)</option>
                        <option value="High">High ($95/day)</option>
                    </select>
                </div>
                
                <!-- Distance (in KM) -->
                <input type="number" id="distanceKm" placeholder="Distance (in Kilometers)" value="500" min="1" class="input-style w-full p-3 rounded-lg">
            </div>

            <button id="estimateButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition duration-200 shadow-lg transform hover:scale-[1.01]">
                Estimate Trip Cost
            </button>
            
            <div id="responseContainer" class="mt-8 p-4 rounded-lg border border-gray-600 transition duration-300 bg-[#3b3b5c]">
                <p class="font-semibold text-gray-200 mb-1">Estimated Cost Breakdown:</p>
                <div id="responseOutput" class="whitespace-pre-wrap text-sm font-mono text-accent-color">Enter details and click 'Estimate'</div>
                <p id="messageOutput" class="text-sm mt-2 text-gray-400"></p>
            </div>
        </div>

    </div>

    <!-- Firebase Scripts -->
    <script type="module">
        // Removed extraneous Markdown link brackets from the module specifiers
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Mock Firebase Config for local testing (Live Server)
        const MOCK_FIREBASE_CONFIG = {
            apiKey: "mock-key", 
            projectId: "mock-project"
        };
        
        // Use provided Canvas config or fall back to mock
        const isCanvasEnvironment = typeof __firebase_config !== 'undefined' && typeof __initial_auth_token !== 'undefined';
        
        let firebaseConfig, initialAuthToken;

        if (isCanvasEnvironment) {
            firebaseConfig = JSON.parse(__firebase_config);
            initialAuthToken = __initial_auth_token;
            console.log("Firebase: Canvas environment detected. Using provided configuration.");
        } else {
            // FALLBACK FOR LIVE SERVER
            firebaseConfig = MOCK_FIREBASE_CONFIG;
            initialAuthToken = null;
            console.warn("Firebase: Canvas configuration missing. Using mock fallback. Authentication functionality will be limited.");
        }

        let auth;
        let db;
        let userId = null;
        let isAuthReady = false;
        
        // DOM Elements
        const loadingScreen = document.getElementById('loadingScreen');
        const mainAppContainer = document.getElementById('mainAppContainer');
        const authView = document.getElementById('authView');
        const estimationView = document.getElementById('estimationView');
        const loginButton = document.getElementById('loginButton');
        const signupButton = document.getElementById('signupButton');
        const logoutButton = document.getElementById('logoutButton');
        const authMessage = document.getElementById('authMessage');
        const welcomeMessage = document.getElementById('welcomeMessage');

        // Initialize Firebase and Authentication
        async function initFirebase() {
            try {
                if (Object.keys(firebaseConfig).length === 0 || firebaseConfig.apiKey === "mock-key") {
                    // Skip Firebase initialization, use mock login flow
                    isAuthReady = true;
                    userId = null;
                    renderView('auth');
                    console.warn("Skipping real Firebase setup. Showing Auth view for local testing.");
                    hideLoadingScreen();
                    return;
                }

                // If a real config is present, proceed with initialization
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken).catch(e => {
                        console.warn("Custom token sign-in failed, trying anonymous.", e);
                        return signInAnonymously(auth);
                    });
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    isAuthReady = true;
                    if (user && user.email) { 
                        userId = user.uid;
                        renderView('estimation');
                        welcomeMessage.textContent = `Welcome, ${user.email}!`;
                        logoutButton.classList.remove('hidden');
                    } else if (user) { 
                        userId = user.uid;
                        renderView('estimation');
                        welcomeMessage.textContent = `Welcome (Guest)! ID: ${userId.substring(0, 8)}...`;
                        logoutButton.classList.remove('hidden');
                    } else {
                        userId = null;
                        renderView('auth');
                        logoutButton.classList.add('hidden');
                    }
                    hideLoadingScreen();
                });

            } catch (error) {
                console.error("Firebase initialization error:", error);
                loadingScreen.innerHTML = '<p class="text-red-500">Initialization Failed. Check console for network errors.</p>';
            }
        }
        
        function hideLoadingScreen() {
            loadingScreen.classList.add('opacity-0');
            setTimeout(() => loadingScreen.classList.add('hidden'), 500);
            mainAppContainer.classList.remove('hidden');
        }

        // --- UI Rendering ---
        function renderView(view) {
            authView.classList.add('hidden');
            estimationView.classList.add('hidden');
            if (view === 'auth') {
                authView.classList.remove('hidden');
            } else if (view === 'estimation') {
                estimationView.classList.remove('hidden');
            }
        }
        
        function showAuthMessage(message, isError = false) {
            authMessage.textContent = message;
            authMessage.classList.remove('hidden', 'bg-red-900', 'text-red-200', 'bg-blue-900', 'text-blue-200');
            if (isError) {
                authMessage.classList.add('bg-red-900', 'text-red-200');
            } else {
                authMessage.classList.add('bg-blue-900', 'text-blue-200');
            }
        }

        // --- Authentication Handlers ---
        loginButton.addEventListener('click', async () => {
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            
            if (!email || !password) {
                showAuthMessage("Please enter both email and password.", true);
                return;
            }
            
            if (!auth) {
                 // ** LOCAL TESTING PATH **
                 showAuthMessage("Authentication is disabled in this local environment. Entering as mock user...", false);
                 userId = 'mock-user-123';
                 renderView('estimation');
                 logoutButton.classList.remove('hidden');
                 welcomeMessage.textContent = `Welcome, Mock User!`;
                 return;
            }
            
            // ** REAL FIREBASE PATH **
            try {
                showAuthMessage("Logging in...");
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Login Error:", error);
                showAuthMessage(`Login Failed: ${error.message.substring(0, 50)}...`, true);
            }
        });

        signupButton.addEventListener('click', async () => {
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            
            if (!email || !password) {
                showAuthMessage("Please enter both email and password.", true);
                return;
            }
            
            if (!auth) {
                 // ** LOCAL TESTING PATH **
                 showAuthMessage("Authentication is disabled in this local environment. Entering as mock user...", false);
                 userId = 'mock-user-123';
                 renderView('estimation');
                 logoutButton.classList.remove('hidden');
                 welcomeMessage.textContent = `Welcome, Mock User!`;
                 return;
            }
            
            // ** REAL FIREBASE PATH **
            try {
                showAuthMessage("Creating account...");
                await createUserWithEmailAndPassword(auth, email, password);
                showAuthMessage("Account created successfully! Logging you in...", false);
            } catch (error) {
                console.error("Signup Error:", error);
                showAuthMessage(`Signup Failed: ${error.message.substring(0, 50)}...`, true);
            }
        });

        logoutButton.addEventListener('click', async () => {
            if (!auth) {
                // Mock logout for local environment
                userId = null;
                renderView('auth');
                showAuthMessage("Mock logout successful. Please use real credentials to log in.", false);
                return;
            }
            try {
                await signOut(auth);
                showAuthMessage("Logged out successfully.", false);
            } catch (error) {
                console.error("Logout Error:", error);
                showAuthMessage(`Logout Failed: ${error.message.substring(0, 50)}...`, true);
            }
        });


        // --- ESTIMATION LOGIC ---
        document.getElementById('estimateButton').addEventListener('click', handleEstimation);

        async function handleEstimation() {
            // Check if user is authenticated (real or mock)
            if (!userId) {
                showAuthMessage("Please log in or sign up to run the estimation.", true);
                renderView('auth');
                return;
            }

            const output = document.getElementById('responseOutput');
            const messageOutput = document.getElementById('messageOutput');

            output.innerHTML = 'Fetching estimate from backend...';
            messageOutput.textContent = 'Sending data to the backend server on port 3001...';

            // Gather all data points (NOW INCLUDES activityPreference)
            const dataToSend = {
                userId: userId, 
                startLocation: document.getElementById('startLocation').value,
                destination: document.getElementById('destination').value,
                country: document.getElementById('country').value,
                transportType: document.getElementById('transportType').value,
                numberOfDays: parseInt(document.getElementById('numberOfDays').value),
                accommodationType: document.getElementById('accommodationType').value,
                foodPreference: document.getElementById('foodPreference').value,
                activityPreference: document.getElementById('activityPreference').value, // NEW DATA POINT
                distanceKm: parseFloat(document.getElementById('distanceKm').value)
            };
            
            // Basic Input Validation
            if (!dataToSend.startLocation || !dataToSend.destination || !dataToSend.transportType || !dataToSend.accommodationType || !dataToSend.foodPreference || !dataToSend.activityPreference || isNaN(dataToSend.numberOfDays) || isNaN(dataToSend.distanceKm)) {
                output.innerHTML = '<span class="text-red-500">Error: Please fill out all required fields and select options.</span>';
                messageOutput.textContent = '';
                return;
            }

            try {
                const apiUrl = 'http://localhost:3001/api/estimate'; 
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dataToSend)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const result = await response.json();
                
                // Success: Display the detailed breakdown
                let breakdownHTML = `
                    <div class="mb-3 text-3xl font-extrabold text-white bg-blue-700/80 p-3 rounded-lg text-center">
                        Total: $${result.estimatedCost}
                    </div>
                    <div class="space-y-2">
                        <div class="breakdown-item text-yellow-300">
                            <span>Accommodation (ML Mock)</span>
                            <span>$${result.breakdown.accommodation}</span>
                        </div>
                        <div class="breakdown-item text-green-300">
                            <span>Transportation (ML Mock)</span>
                            <span>$${result.breakdown.transportation}</span>
                        </div>
                        <div class="breakdown-item text-accent-color">
                            <span>Food (Rule-Based)</span>
                            <span>$${result.breakdown.food}</span>
                        </div>
                        <div class="breakdown-item" style="color: var(--activity-color);">
                            <span>Activity (Rule-Based)</span>
                            <span>$${result.breakdown.activity}</span>
                        </div>
                    </div>
                `;

                output.innerHTML = breakdownHTML;
                messageOutput.textContent = result.message || 'Calculation received successfully.';

            } catch (error) {
                console.error("Fetch Error:", error);
                output.innerHTML = `<span class="text-red-500">Error: Failed to connect to server.</span>`;
                messageOutput.textContent = `Details: Check if server is running on port 3001 and if CORS is configured correctly.`;
            }
        }

        initFirebase();
    </script>
</body>
</html>